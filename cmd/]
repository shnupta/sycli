package main

import (
	"fmt"
	"log"
	"net"
	"os"
	"os/exec"

	"github.com/shnupta/sycli"
)

func main() {
	argLen := len(os.Args)
	if argLen == 1 {
		fmt.Printf(HELP_MESSAGE)
		return
	}

	switch os.Args[1] {
	case C_RUN:
		if argLen != 3 {
			fmt.Printf(RUN_HELP_MESSAGE)
		} else {
			run(os.Args[2])
		}
	case C_KILL:
		kill()
	default:
		fmt.Printf(HELP_MESSAGE)
	}
}

const (
	HELP_MESSAGE     = "Usage:\n\tsycli <command> [options...]\n\nCommands:\n- run [youtube link]\n"
	RUN_HELP_MESSAGE = "Usage:\n\tsycli run [youtube link]\n"
	C_RUN            = "run"
	C_KILL           = "kill"
)

func connect() *net.UnixConn {
	addr := net.UnixAddr{Name: "/tmp/mpvsocket", Net: "unix"}
	conn, err := net.DialUnix("unix", &addr, &addr)
	if err != nil {
		log.Fatalln(err)
	}
	return conn
}

func run(url string) {
	cmd := exec.Command("streamlink", "--player", "mpv --no-video --input-ipc-server=/tmp/mpvsocket", url, "best")
	err := cmd.Start()
	if err != nil {
		log.Fatal(err)
	}
}

func kill() {
	conn := connect()
	defer conn.Close()
	com := sycli.Command{CommandName: "quit"}
	sycli.SendCommand(com, conn)
}
